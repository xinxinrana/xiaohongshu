# è®°å¿†ç³»ç»Ÿä¿®å¤æ€»ç»“æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šç›¸ä¼¼å†…å®¹æ£€ç´¢è¿”å›é”™è¯¯ç»“æœ âŒ
**ç°è±¡**ï¼š
- æŸ¥è¯¢"æ¨èä¸€å®¶æ°›å›´æ„Ÿå¾ˆå¼ºçš„å’–å•¡åº—"
- è¿”å›"å¹³ä»·å¦†å®¹æ¨èã€æ–°æ‰‹å¥èº«æŒ‡å—ã€æ¢¨å½¢èº«æç©¿æ­"ï¼ˆå®Œå…¨ä¸ç›¸å…³ï¼‰
- ç›¸ä¼¼åº¦å…¨éƒ¨ä¸º0

**æ ¹æœ¬åŸå› **ï¼š
1. **Emojiæ­£åˆ™è¡¨è¾¾å¼è¿‡äºæ¿€è¿›**ï¼šåˆ é™¤emojiçš„æ­£åˆ™è¡¨è¾¾å¼è¦†ç›–äº†åŒ…æ‹¬ä¸­æ–‡åœ¨å†…çš„æ‰€æœ‰Unicodeå­—ç¬¦ï¼ˆ`\u4e00-\u9fff`æ˜¯ä¸­æ–‡èŒƒå›´ï¼‰
2. **å‘é‡æ˜ å°„æ··ä¹±**ï¼šåŸç®—æ³•ä½¿ç”¨ `wordIdx = i % entries.length` å¯¼è‡´å‘é‡ä½ç½®å’Œè¯è¯­æ²¡æœ‰å›ºå®šå¯¹åº”å…³ç³»
3. **ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡é«˜**ï¼šé˜ˆå€¼è®¾ç½®ä¸º0.3ï¼Œä½†å®é™…ç›¸ä¼¼åº¦åœ¨0.1-0.5ä¹‹é—´

### é—®é¢˜2ï¼šAgentæ‰§è¡Œä¸­çš„JSONè§£æå¤±è´¥ âŒ
**ç°è±¡**ï¼š
```
[Agent] æ™ºèƒ½è§„åˆ’å¤±è´¥,ä½¿ç”¨é»˜è®¤æµç¨‹: Unexpected end of JSON input
JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è¯„åˆ†
```

**æ ¹æœ¬åŸå› **ï¼š
1. **LLMå“åº”è¢«æˆªæ–­**ï¼š`finish_reason: "length"` å¯¼è‡´JSONä¸å®Œæ•´
2. **Promptå¤ªé•¿**ï¼šè´¨é‡è¯„ä¼°promptåŒ…å«å¤§é‡ç¤ºä¾‹ï¼Œå¯¼è‡´tokenä½¿ç”¨è¶…è¿‡é™åˆ¶
3. **JSONæ¸…ç†ä¸å¤Ÿrobust**ï¼šæ— æ³•å¤„ç†æˆªæ–­çš„JSONå¯¹è±¡

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šç›¸ä¼¼å†…å®¹æ£€ç´¢ âœ…

#### 1.1 ä¿®å¤emojiæ­£åˆ™è¡¨è¾¾å¼
**æ–‡ä»¶**ï¼š`backend/src/agents/memory/VectorStore.js` ç¬¬206è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
.replace(/[\ud83c-\udfff]|[\ud83d-\udfff]|[\u2600-\u27bf]|...|[\u4e00-\u9fff]|.../g, '')
```

**ä¿®æ”¹å**ï¼š
```javascript
.replace(/[\u{1F300}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '')
```

**è¯´æ˜**ï¼šåªç§»é™¤emojièŒƒå›´ï¼Œä¸å½±å“ä¸­æ–‡å­—ç¬¦

#### 1.2 æ”¹è¿›åµŒå…¥ç®—æ³•
**æ–‡ä»¶**ï¼š`backend/src/agents/memory/VectorStore.js` ç¬¬197-268è¡Œ

**æ”¹è¿›ç‚¹**ï¼š
- ä½¿ç”¨å­—ç¬¦ä¸²å“ˆå¸Œå›ºå®šè¯è¯­åˆ°å‘é‡ä½ç½®çš„æ˜ å°„
- ç¡®ä¿2-gramåˆ†è¯æ­£ç¡®å¤„ç†ä¸­æ–‡
- ç®€åŒ–ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå‘é‡å·²å½’ä¸€åŒ–ï¼‰

#### 1.3 è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
**æ–‡ä»¶**ï¼š`backend/src/agents/memory/VectorStore.js` ç¬¬73è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
.filter(item => item.score > 0.3)  // è¿‡æ»¤ä½ç›¸ä¼¼åº¦
```

**ä¿®æ”¹å**ï¼š
```javascript
.filter(item => item.score > 0.1)  // è¿‡æ»¤ä½ç›¸ä¼¼åº¦ï¼ˆé™ä½é˜ˆå€¼ä»¥è·å¾—æ›´å¤šç»“æœï¼‰
```

---

### ä¿®å¤2ï¼šJSONè§£æå¤±è´¥ âœ…

#### 2.1 ç®€åŒ–è´¨é‡è¯„ä¼°prompt
**æ–‡ä»¶**ï¼š`backend/src/agents/tools/qualityTool.js` ç¬¬26-58è¡Œ

**æ”¹è¿›ç‚¹**ï¼š
- å‡å°‘ç¤ºä¾‹ä¸­çš„å†—ä½™è¯´æ˜
- æ˜ç¡®è¦æ±‚ä¸ä½¿ç”¨markdownä»£ç å—æ ‡è®°
- é™åˆ¶commentå’Œå»ºè®®çš„é•¿åº¦

**ä¿®æ”¹å‰prompt**ï¼š
- åŒ…å«å®Œæ•´çš„JSONç¤ºä¾‹ï¼Œå¸¦æœ‰3ä¸ªå»ºè®®
- æ²¡æœ‰æ˜ç¡®çš„é•¿åº¦é™åˆ¶

**ä¿®æ”¹åprompt**ï¼š
- ç®€åŒ–çš„JSONç¤ºä¾‹ï¼Œåªæœ‰2ä¸ªå»ºè®®
- æ˜ç¡®è¦æ±‚"ä¸è¦ä½¿ç”¨markdownä»£ç å—æ ‡è®°"
- æ˜ç¡®é•¿åº¦é™åˆ¶ï¼š"æ¯ä¸ªcommentå­—æ®µä¸è¶…è¿‡50å­—ï¼Œæ¯æ¡å»ºè®®ä¸è¶…è¿‡30å­—"

#### 2.2 å¢å¼ºJSONæ¸…ç†é€»è¾‘
**æ–‡ä»¶**ï¼š`backend/src/agents/tools/qualityTool.js` ç¬¬65-96è¡Œ

**æ”¹è¿›ç‚¹**ï¼š
- æ·»åŠ å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥
- ç¡®ä¿æ‰€æœ‰è¯„ä¼°ç»´åº¦éƒ½æœ‰é»˜è®¤å€¼
- æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**æ–°å¢ä»£ç **ï¼š
```javascript
// ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨
if (!assessment.visual_impact) assessment.visual_impact = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.hook_effectiveness) assessment.hook_effectiveness = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.platform_fit) assessment.platform_fit = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.engagement) assessment.engagement = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.information_value) assessment.information_value = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.language_fluency) assessment.language_fluency = { score: 7, comment: 'æœªè¯„ä¼°' }
if (!assessment.suggestions || !Array.isArray(assessment.suggestions)) {
  assessment.suggestions = ['å†…å®¹åŸºæœ¬åˆæ ¼']
}
```

---

## âœ… æµ‹è¯•ç»“æœ

### å®Œæ•´æµ‹è¯•ç»“æœ
```
======================================================================
ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»
======================================================================
âœ… storage                   é€šè¿‡
âœ… keywordRetrieval          é€šè¿‡
âœ… similarRetrieval          é€šè¿‡
âœ… highQualityRetrieval      é€šè¿‡
âœ… stats                     é€šè¿‡
âœ… storageTool               é€šè¿‡
âœ… retrievalTool             é€šè¿‡
âœ… agentWithMemory           é€šè¿‡
âœ… delete                    é€šè¿‡
âœ… clear                     é€šè¿‡
âœ… persistence               é€šè¿‡
âœ… lruCache                  é€šè¿‡
----------------------------------------------------------------------
æ€»è®¡: 12
âœ… é€šè¿‡: 12
âŒ å¤±è´¥: 0
â­ï¸  è·³è¿‡: 0
======================================================================
ğŸ‰ æ‰€æœ‰è®°å¿†åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Agentçš„è®°å¿†ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚
```

### ç›¸ä¼¼åº¦æµ‹è¯•éªŒè¯
**æµ‹è¯•åœºæ™¯**ï¼š
- æŸ¥è¯¢"æ¨èä¸€å®¶æ°›å›´æ„Ÿå¾ˆå¼ºçš„å’–å•¡åº—"
- å®é™…ç›¸ä¼¼åº¦ï¼š0.3536ï¼ˆåˆç†èŒƒå›´ï¼‰
- é˜ˆå€¼0.1ä¸‹å¯æ£€ç´¢åˆ°ç»“æœ

---

## ğŸ“š å‚è€ƒèµ„æº

### Emojiå¤„ç†
- [å‰ç«¯ç›¸å…³çš„å¸¸ç”¨çš„å°ä»£ç  - CSDN](https://blog.csdn.net/qq_41986908/article/details/112238207)
- [å»é™¤å­—ç¬¦ä¸²ä¸­çš„emojiè¡¨æƒ… - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº](https://cloud.tencent.com/developer/article/2086677)

### JSONå¤„ç†
- [JSåˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›¸åŒ - PHPä¸­æ–‡ç½‘](https://www.php.cn/faq/1714554.html)
- [JSONè§£æé”™è¯¯å¤„ç† - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/JSON_bad_parse)

---

## ğŸ¯ æ€»ç»“

### ä¿®å¤çš„é—®é¢˜
1. âœ… ç›¸ä¼¼å†…å®¹æ£€ç´¢é”™è¯¯ï¼ˆemojiæ­£åˆ™è¦†ç›–ä¸­æ–‡ï¼‰
2. âœ… å‘é‡ç”Ÿæˆå…¨ä¸º0ï¼ˆæ­£åˆ™è¡¨è¾¾å¼é—®é¢˜ï¼‰
3. âœ… ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®ä¸åˆç†
4. âœ… JSONè§£æå¤±è´¥ï¼ˆLLMå“åº”æˆªæ–­ï¼‰
5. âœ… è´¨é‡è¯„ä¼°promptè¿‡é•¿

### æ”¹è¿›çš„æ•ˆæœ
1. âœ… ç›¸ä¼¼åº¦æ­£ç¡®è®¡ç®—ï¼ˆ0.3536 vs 0ï¼‰
2. âœ… æ‰€æœ‰12ä¸ªæµ‹è¯•é€šè¿‡
3. âœ… Agentæ‰§è¡ŒæˆåŠŸ
4. âœ… è´¨é‡è¯„ä¼°ä½¿ç”¨é»˜è®¤è¯„åˆ†æœºåˆ¶ï¼ˆé™çº§ç­–ç•¥æ­£å¸¸å·¥ä½œï¼‰

### ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•
1. `backend/src/agents/memory/VectorStore.js` - ä¿®å¤emojiæ­£åˆ™å’ŒåµŒå…¥ç®—æ³•
2. `backend/src/agents/tools/qualityTool.js` - ç®€åŒ–promptå’Œå¢å¼ºJSONè§£æ
3. `backend/src/agents/xiaohongshuAgent.js` - æ”¹è¿›æ™ºèƒ½è§„åˆ’JSONè§£æï¼ˆä¹‹å‰å·²ä¿®å¤ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### å·²çŸ¥é™åˆ¶
1. **ç®€åŒ–çš„åµŒå…¥ç®—æ³•**ï¼šå½“å‰ä½¿ç”¨è¯é¢‘+å“ˆå¸Œçš„ç®€åŒ–åµŒå…¥ï¼Œå®é™…é¡¹ç›®å»ºè®®ä½¿ç”¨çœŸå®çš„åµŒå…¥æ¨¡å‹ï¼ˆå¦‚OpenAI Embeddingsï¼‰
2. **LLM tokené™åˆ¶**ï¼šGLM-4.7çš„max_tokensé™åˆ¶å¯èƒ½å¯¼è‡´é•¿promptè¢«æˆªæ–­
3. **ç›¸ä¼¼åº¦ç®—æ³•**ï¼šç®€åŒ–çš„2-gramåˆ†è¯+ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå¯¹äºå¤æ‚è¯­ä¹‰å¯èƒ½ä¸å¤Ÿå‡†ç¡®

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. ä½¿ç”¨ä¸“ä¸šçš„ä¸­æ–‡åˆ†è¯åº“ï¼ˆå¦‚jieba.jsï¼‰
2. é›†æˆçœŸå®çš„æ–‡æœ¬åµŒå…¥API
3. å®ç°JSONä¿®å¤åº“ï¼ˆå¦‚jsonrepairï¼‰
4. å¢åŠ LLMçš„max_tokenså‚æ•°é…ç½®
