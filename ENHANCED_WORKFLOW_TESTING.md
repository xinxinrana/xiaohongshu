# 增强版工作流测试验证指南

## 功能概述

增强版工作流是在原有工作流基础上创建的全新功能，支持多轮迭代优化和用户满意度反馈循环。

## 核心特性

### 1. 新模式按钮
- 位置：底部输入框右侧，带有火箭图标
- 功能：切换普通模式和增强模式
- 状态：点击后按钮高亮显示紫色渐变色

### 2. 增强版生成流程

#### 阶段一：初始生成
1. **文案生成（第1次AI调用）**
   - 使用GLM-4.7模型（通过callAI函数调用）
   - 支持流式传输实时展示
   - 根据用户输入的关键词和对话内容生成文案
   - 支持参考图（可选）

2. **提示词工程（第2次AI调用）**
   - 基于生成的文案自动生成3个配图提示词
   - 提示词针对Doubao-Seedream-4.0模型优化
   - 支持参考图影响（可选）

3. **图像生成（调用图像模型）**
   - 使用Doubao-Seedream-4.0模型（通过ImageService调用）
   - 根据3个提示词生成3张配图
   - 支持用户上传原始图片作为参考（图生图功能）
   - 采用轮询机制获取生成结果

#### 阶段二：满意度反馈循环
4. **满意度确认模态框**
   - 自动弹出，提供两个选项：
     - ✅ 满意并接受：进入质量分析
     - 🔧 我需要修改：进入修改模式

#### 阶段三：修改模式（如果选择"我需要修改"）
5. **修改界面**
   - 文本输入框：【请输入修改文案的想法】（必填）
   - 文本输入框：【请输入修改图片的想法】（必填）
   - 图片上传区域：【上传参考图】（可选）
   - 操作按钮：【发送】、【返回】
   - **约束**：必须同时填写两个文本框才能发送

#### 阶段四：修改处理
6. **文案编辑（第3次AI调用）**
   - 将原文案和用户修改想法发送给GLM-4.7
   - 生成新文案并返回前端展示

7. **提示词优化和图像编辑（第4次AI调用）**
   - 根据用户修改图片的想法优化提示词
   - 结合用户上传的参考图片
   - 调用Doubao-Seedream-4.0生成新的3张图片

#### 阶段五：循环迭代
8. **重复满意度确认**
   - 每次修改完成后再次弹出满意度确认
   - 可以多次迭代优化
   - 迭代次数会在模态框标题显示

9. **最终质量分析**
   - 用户点击【满意并接受】后触发
   - 调用GLM-4.7生成质量分析报告
   - 包含4个维度：Hook分析、框架分析、结构分析、平台适配
   - 支持流式传输实时展示

## 测试步骤

### 测试前准备
1. 启动后端服务：
   ```bash
   cd backend
   npm run dev
   ```

2. 启动前端服务：
   ```bash
   npm run dev
   ```

3. 确保环境变量配置正确（AI API密钥、图像API密钥）

### 测试场景1：完整增强版流程

**步骤：**
1. 打开应用，点击底部输入框旁的火箭图标（增强模式按钮）
2. 确认按钮变为紫色渐变色，显示提示"已切换到增强模式"
3. 输入测试关键词，例如："冬季护肤"
4. 点击发送按钮
5. 观察生成进度：
   - 阶段1/4：正在生成文案内容（GLM-4.7模型，支持流式传输）
   - 阶段2/4：正在生成配图提示词（AI提示词工程）
   - 阶段3/4：正在生成配图（Doubao-Seedream-4.0模型，支持轮询）
   - 阶段4/4：初始生成完成
6. 满意度模态框自动弹出
7. 点击【我需要修改】
8. 在修改界面填写：
   - 文案修改想法："增加更多互动性提问，语气更活泼"
   - 图片修改想法："希望背景更温馨，色调偏暖"
9. 点击【发送】
10. 观察迭代优化进度：
    - 步骤1/3：文案编辑（GLM-4.7模型，支持流式传输）
    - 步骤2/3：提示词优化（AI优化提示词）
    - 步骤3/3：图像编辑（Doubao-Seedream-4.0模型）
11. 再次弹出满意度确认模态框，标题显示"第2次生成完成"
12. 点击【满意并接受】
13. 系统生成质量分析报告（GLM-4.7模型，支持流式传输）
14. 验证质量分析内容显示正确

**预期结果：**
- ✅ 所有阶段顺利执行
- ✅ 文案和图片都完成迭代优化
- ✅ 质量分析报告成功生成
- ✅ 历史记录保存迭代信息
- ✅ 支持流式传输实时显示
- ✅ 图像生成支持轮询机制

### 测试场景2：多次迭代优化

**步骤：**
1. 按照测试场景1完成第一次修改
2. 在第2次满意度确认时，再次选择【我需要修改】
3. 填写新的修改意见
4. 观察第2次迭代（文案编辑→提示词优化→图像编辑）
5. 重复2-3次迭代
6. 最后点击【满意并接受】

**预期结果：**
- ✅ 支持多次迭代（无上限）
- ✅ 每次迭代计数正确显示
- ✅ 历史记录保存所有迭代数据
- ✅ 每次迭代都有完整的流程

### 测试场景3：上传参考图

**步骤：**
1. 启动增强模式生成前，在KeywordInput组件中上传一张参考图片
2. 执行增强模式生成
3. 在修改界面再次上传一张参考图片
4. 填写修改意见并发送
5. 验证生成的新图片是否参考了上传的图片风格

**预期结果：**
- ✅ 参考图上传成功
- ✅ 新生成的图片受参考图影响
- ✅ 支持Base64格式图片传输
- ✅ 图生图功能正常

### 测试场景4：验证表单约束

**步骤：**
1. 启动增强模式生成
2. 在修改界面只填写文案修改，不填写图片修改
3. 点击【发送】
4. 观察是否有警告提示

**预期结果：**
- ✅ 显示警告："请同时填写文案和图片的修改想法"
- ✅ 不允许提交
- ✅ 表单验证功能正常

### 测试场景5：历史记录验证

**步骤：**
1. 完成一次完整的增强版生成（包含迭代）
2. 刷新页面
3. 检查localStorage中的增强版历史记录
4. 验证迭代记录是否正确保存

**预期结果：**
- ✅ 历史记录正确保存
- ✅ 包含sessionId、迭代次数、所有迭代数据
- ✅ 可以加载历史记录查看
- ✅ 迭代记录完整保存
- ✅ 支持会话级别的历史管理

### 测试场景6：普通模式和增强模式切换

**步骤：**
1. 使用增强模式生成一次
2. 关闭增强模式按钮（再次点击火箭图标）
3. 再次生成内容
4. 验证是否走普通流程（无满意度确认）
5. 再次开启增强模式

**预期结果：**
- ✅ 模式切换正常
- ✅ 普通模式不弹出满意度确认
- ✅ 增强模式正常弹出满意度确认
- ✅ 模式状态正确保存

### 测试场景7：流式传输验证

**步骤：**
1. 启动增强模式生成
2. 观察文案生成过程中的流式输出
3. 在修改模式下观察文案编辑的流式输出
4. 观察质量分析的流式输出

**预期结果：**
- ✅ 文案生成支持实时流式显示
- ✅ 文案编辑支持实时流式显示
- ✅ 质量分析支持实时流式显示
- ✅ 用户体验流畅

### 测试场景8：API错误处理

**步骤：**
1. 模拟API调用失败（如网络错误）
2. 观察错误处理和用户提示
3. 验证系统是否能优雅处理各种错误情况

**预期结果：**
- ✅ 错误被正确捕获
- ✅ 用户收到友好的错误提示
- ✅ 系统不会崩溃
- ✅ 日志记录错误信息

## 已知功能点

### 数据持久化
- ✅ 每次生成自动保存到localStorage
- ✅ 迭代记录单独保存
- ✅ 支持历史记录查询

### 数据隔离
- ✅ 增强版历史使用独立的localStorage键
- ✅ 普通模式和增强模式数据互不干扰

### API路由
- ✅ 所有增强版API路由以`/api/enhanced/`为前缀
- ✅ 与原有API路由完全隔离

## 技术架构

### 后端服务
- **服务层**：`backend/src/services/enhancedGenerationService.js`
  - `generateContent()`：文案生成
  - `generateImagePrompts()`：提示词工程
  - `generateImages()`：图像生成（支持图生图）
  - `editContent()`：文案编辑
  - `optimizeImagePrompts()`：提示词优化
  - `editImages()`：图像编辑
  - `generateFinalAnalysis()`：质量分析
  - `pollTaskStatus()`：图像生成轮询
  - `callAI()`：AI模型调用函数（在aiService.js中定义）
  - `ImageService`：图像生成服务（在imageService.js中定义）
- **控制器**：`backend/src/controllers/enhancedGenerationController.js`
  - `generateContent()`：文案生成接口 `/api/enhanced/generate-content`
  - `generatePrompts()`：提示词生成接口 `/api/enhanced/generate-prompts`
  - `generateImages()`：图像生成接口 `/api/enhanced/generate-images`
  - `editContent()`：文案编辑接口 `/api/enhanced/edit-content`
  - `optimizePrompts()`：提示词优化接口 `/api/enhanced/optimize-prompts`
  - `editImages()`：图像编辑接口 `/api/enhanced/edit-images`
  - `generateFinalAnalysis()`：质量分析接口 `/api/enhanced/final-analysis`
  - `fullProcess()`：一键完整流程接口 `/api/enhanced/full-process`
- **路由**：`backend/src/routes/index.js`（增强版路由 `/api/enhanced/`）

### 前端服务
- **API服务**：`src/services/api.js`（enhancedAPI对象）
  - `generateContent()`：文案生成
  - `generatePrompts()`：提示词生成
  - `generateImages()`：图像生成
  - `editContent()`：文案编辑（支持流式）
  - `optimizePrompts()`：提示词优化
  - `editImages()`：图像编辑
  - `generateFinalAnalysis()`：质量分析（支持流式）
  - `fullProcess()`：一键完整流程
- **历史服务**：`src/services/history.js`（enhancedHistoryService对象）
  - `save()`：保存增强版历史记录
  - `updateIteration()`：更新迭代记录
  - `getIterations()`：获取迭代记录
- **主页面**：`src/views/Generate.vue`（增强版工作流逻辑）
- **模态框组件**：`src/components/SatisfactionModal.vue`（满意度反馈）
- **输入组件**：`src/components/KeywordInput.vue`（火箭图标按钮、图片上传）
- **图片服务**：`backend/src/services/imageService.js`（图像生成和轮询）

## 注意事项

1. **API密钥**：确保GLM-4.7和Doubao-Seedream-4.0的API密钥配置正确
2. **超时设置**：图像生成可能需要较长时间，已设置120秒超时，轮询机制最多尝试30次，每次间隔2秒
3. **流式传输**：文案生成、编辑和质量分析支持流式传输，提升用户体验
4. **错误处理**：所有API调用都有错误处理和用户提示
5. **性能优化**：多个图像并行生成，加快处理速度
6. **图片处理**：支持Base64格式图片上传，用于图生图功能
7. **会话管理**：使用sessionId管理单次会话的多次迭代
8. **数据隔离**：增强版历史与普通版历史使用独立的localStorage键

## 下一步优化建议

1. **图片上传**：实现真正的图片上传到云存储，而不是本地预览
2. **历史记录UI**：在侧边栏展示增强版历史记录，支持查看迭代详情
3. **导出功能**：支持导出完整的迭代历史和所有版本的文案/图片
4. **A/B测试**：支持在多个迭代版本之间对比选择
5. **AI建议**：在修改界面提供AI优化建议
6. **协作功能**：支持团队成员共同迭代优化
7. **模板保存**：将优秀的迭代流程保存为模板供复用
8. **进度可视化**：增强进度条和状态指示，让用户更清楚当前处理阶段
9. **批量处理**：支持批量处理多个关键词或文案
10. **质量评估**：引入更全面的内容质量评估机制
11. **智能推荐**：基于历史数据智能推荐优化方向
12. **版本对比**：提供不同迭代版本间的可视化对比功能

## 已知限制

1. **并发限制**：图像生成服务可能有限制并发请求数
2. **API费用**：多次迭代会增加API调用成本
3. **图片质量**：图生图功能的效果依赖于参考图质量和模型能力
4. **网络稳定性**：长时间的轮询操作需要稳定的网络连接
5. **浏览器兼容性**：部分功能（如文件读取）可能存在浏览器兼容性问题

## 问题反馈

如遇到问题，请检查：
1. 浏览器控制台是否有错误信息
2. 网络请求是否正常（Network标签）
3. localStorage中的历史记录数据是否正确
4. 后端日志是否有API调用失败记录

---

**创建时间**：2026-01-17
**版本**：v1.0
**维护者**：开发团队
